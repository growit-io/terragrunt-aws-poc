name: 'Integration'

on: [pull_request]

jobs:
  commitlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - id: merge-base
        run: |
          # Detect merge commit with unrelated histories
          head_ref=$(git rev-parse ${{ github.event.pull_request.head.sha }})
          commit=$(git cat-file -p $head_ref)
          unrelated_histories=false

          if [[ $(grep -c '^parent ' <<<"$commit") -gt 1 ]]; then
            parents=$(awk '/^parent / {print $2}' <<<"$commit")

            if ! git merge-base --is-ancestor $(echo $parents); then
              unrelated_histories=true
            fi
          fi

          echo ::set-output name=unrelated-histories::$unrelated_histories
      - # https://github.com/wagoid/commitlint-github-action
        # The commitlint action does not handle unrelated histories and fails,
        # so we detect this condition and skip the step, only in that case.
        if: steps.merge-base.outputs.unrelated-histories == 'false'
        uses: wagoid/commitlint-github-action@v4
        with:
          configFile: .commitlint.config.js
          firstParent: false
          failOnWarnings: true
          helpURL: 'https://github.com/conventional-changelog/commitlint/#what-is-commitlint'

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Setup TFLint'
        uses: terraform-linters/setup-tflint@v1
        with:
          tflint_version: v0.31.0
      - name: 'Setup TFLint plugin cache'
        uses: actions/cache@v2
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ hashFiles('.tflint.hcl') }}
      - name: 'Download TFLint plugins'
        run: tflint --init
      - name: 'Check for common violations of best practices'
        uses: ./.github/actions/terragrunt
        with:
          command: lint
          init: false

  examples:
    name: 'Examples'
    if: ${{ ! startsWith(github.head_ref, 'release-v') }}
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Create execution plans'
        id: main
        uses: ./.github/actions/terragrunt
        with:
          command: plan
          config-paths: 'examples'
    outputs:
      changed-paths: ${{ steps.main.outputs.changed-paths }}

  feedback:
    name: 'Feedback'
    needs: [examples]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: 'Generate feedback'
        id: feedback
        uses: ./.github/actions/feedback
        with:
          needs: ${{ toJSON(needs) }}
